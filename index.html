<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Tenda Monitor</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0b1020" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #0b1020;
      color: #fff;
    }

    header {
      padding: 16px;
      font-size: 26px;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    button {
      background: #1e293b;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
    }

    .banner {
      padding: 16px;
      font-weight: 700;
    }

    .aperto { background: #1f7a33; }
    .chiuso { background: #8b1e1e; }
    .limitato { background: #b37a00; }
    .unknown { background: #444; }

    main {
      display: flex;
      flex-direction: column;
    }

    section {
      padding: 16px;
    }

    .label {
      opacity: 0.7;
      font-size: 14px;
    }

    .value {
      font-size: 20px;
      margin-bottom: 12px;
    }

    #map {
      width: 100%;
      height: 420px;
      border-radius: 10px;
    }
  </style>

  <!-- Google Maps -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD3H4aVAjeJQIERs5hXDCKlZZJMv64GHmo&callback=initMap"
    async defer>
  </script>
</head>

<body>
<header>
  <span>Tenda Monitor</span>
</header>

<div id="banner" class="banner unknown">
  <div id="banner-text">Aggiornamento…</div>
</div>

<main>
  <section>
    <div class="label">Stato tunnel</div>
    <div class="value" id="stato">—</div>

    <div class="label">Traffico</div>
    <div class="value" id="traffico">—</div>

    <div class="label">Veicoli stimati</div>
    <div class="value" id="veicoli">—</div>

    <div class="label">Ultimo aggiornamento</div>
    <div class="value" id="aggiornato">—</div>
  </section>

  <section>
    <h2>Traffico in tempo reale</h2>
    <div id="map"></div>
  </section>
</main>

<script>
/* === SERVICE WORKER === */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}

/* === DATI === */
const API = "https://tenda-regole.massimiliano-cesar.workers.dev/";

async function caricaDati() {
  try {
    const res = await fetch(API, { cache: "no-store" });
    const data = await res.json();

    document.getElementById("stato").textContent = data.stato;
    document.getElementById("traffico").textContent = data.traffico;
    document.getElementById("veicoli").textContent = data.stima_veicoli ?? 0;
    document.getElementById("aggiornato").textContent =
      new Date(data.aggiornato).toLocaleString("it-IT");

    const banner = document.getElementById("banner");
    banner.className = "banner " + (data.stato?.toLowerCase() || "unknown");
    document.getElementById("banner-text").textContent =
      "Tunnel " + (data.stato || "—");

  } catch (e) {
    console.error(e);
  }
}

function initMap() {
  const tenda = { lat: 44.1541066, lng: 7.5661378 };
  const map = new google.maps.Map(document.getElementById("map"), {
    center: tenda,
    zoom: 14
  });

  new google.maps.Marker({ position: tenda, map });
  new google.maps.TrafficLayer().setMap(map);
}

caricaDati();
setInterval(caricaDati, 30000);
</script>
</body>
</html>
