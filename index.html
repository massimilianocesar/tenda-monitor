<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Tenda Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #0b1020;
      color: #fff;
    }

    body.office {
      font-size: 20px;
    }

    header {
      padding: 16px;
      font-size: 26px;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    button {
      background: #1e293b;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
    }

    .banner {
      padding: 16px;
      font-weight: 700;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .aperto { background: #1f7a33; }
    .chiuso { background: #8b1e1e; }
    .limitato { background: #b37a00; }
    .unknown { background: #444; }

    main {
      display: flex;
      flex-direction: column;
    }

    body.office main {
      flex-direction: row;
      height: calc(100vh - 140px);
    }

    section {
      padding: 16px;
      flex: 1;
      overflow: auto;
    }

    .label {
      opacity: 0.7;
      font-size: 14px;
    }

    .value {
      font-size: 18px;
      margin-bottom: 12px;
    }

    body.office .value {
      font-size: 26px;
    }

    #map {
      width: 100%;
      height: 420px;
      border-radius: 10px;
      margin-bottom: 12px;
    }

    body.office #map {
      height: 100%;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
    }

    th, td {
      border-bottom: 1px solid #334155;
      padding: 6px;
      text-align: left;
    }

    th {
      opacity: 0.7;
    }
  </style>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD3H4aVAjeJQIERs5hXDCKlZZJMv64GHmo&callback=initMap"
    async defer>
  </script>
</head>

<body>
  <header>
    <span>Tenda Monitor</span>
    <div>
      <button id="soundToggle">ðŸ”• Avvisi OFF</button>
      <button id="officeToggle">ModalitÃ  ufficio</button>
      <button id="historyToggle">ðŸ“Š Storico</button>
    </div>
  </header>

  <div id="banner" class="banner unknown">
    <div id="banner-text">Aggiornamentoâ€¦</div>
    <div id="banner-extra"></div>
  </div>

  <main>
    <section>
      <div class="label">Stato tunnel</div>
      <div class="value" id="stato">â€”</div>

      <div class="label">Traffico</div>
      <div class="value" id="traffico">â€”</div>

      <div class="label">Veicoli stimati</div>
      <div class="value" id="veicoli">â€”</div>

      <div class="label">Ultimo aggiornamento</div>
      <div class="value" id="aggiornato">â€”</div>

      <div id="storico" style="display:none;">
        <h2>Storico di oggi</h2>
        <table>
          <thead>
            <tr>
              <th>Ora</th>
              <th>Stato</th>
              <th>Traffico</th>
              <th>Veicoli</th>
            </tr>
          </thead>
          <tbody id="storico-body"></tbody>
        </table>
      </div>
    </section>

    <section>
      <h2>Traffico in tempo reale</h2>
      <div id="map"></div>
    </section>
  </main>

<script>
const ENDPOINT = "https://tenda-regole.massimiliano-cesar.workers.dev/";
const todayKey = "storico-" + new Date().toISOString().slice(0,10);

let soundEnabled = localStorage.getItem("sound") === "true";
let lastStato = null;

const storicoBody = document.getElementById("storico-body");

function salvaStorico(data) {
  const storico = JSON.parse(localStorage.getItem(todayKey) || "[]");
  storico.push({
    ora: new Date().toLocaleTimeString("it-IT"),
    stato: data.stato,
    traffico: data.traffico,
    veicoli: data.stima_veicoli ?? 0
  });
  localStorage.setItem(todayKey, JSON.stringify(storico));
}

function renderStorico() {
  const storico = JSON.parse(localStorage.getItem(todayKey) || "[]");
  storicoBody.innerHTML = "";
  storico.forEach(r => {
    storicoBody.innerHTML += `
      <tr>
        <td>${r.ora}</td>
        <td>${r.stato}</td>
        <td>${r.traffico}</td>
        <td>${r.veicoli}</td>
      </tr>`;
  });
}

async function caricaStato() {
  try {
    const res = await fetch(ENDPOINT, { cache: "no-store" });
    const data = await res.json();

    document.getElementById("stato").textContent = data.stato;
    document.getElementById("traffico").textContent = data.traffico;
    document.getElementById("veicoli").textContent = data.stima_veicoli ?? 0;
    document.getElementById("aggiornato").textContent =
      new Date(data.aggiornato).toLocaleString("it-IT");

    salvaStorico(data);
    if (document.getElementById("storico").style.display !== "none") {
      renderStorico();
    }
  } catch (e) {
    console.error(e);
  }
}

document.getElementById("historyToggle").onclick = () => {
  const box = document.getElementById("storico");
  box.style.display = box.style.display === "none" ? "block" : "none";
  renderStorico();
};

function initMap() {
  const tenda = { lat: 44.1541066, lng: 7.5661378 };
  const map = new google.maps.Map(document.getElementById("map"), {
    center: tenda,
    zoom: 14,
  });
  new google.maps.Marker({ position: tenda, map });
  new google.maps.TrafficLayer().setMap(map);
}

caricaStato();
setInterval(caricaStato, 30_000);
</script>
</body>
</html>
