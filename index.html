<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Tenda Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0b1020;
      color: #ffffff;
    }

    body.office {
      font-size: 20px;
    }

    header {
      padding: 16px;
      font-size: 26px;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    button {
      background: #1e293b;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    body.office button {
      font-size: 18px;
    }

    .banner {
      padding: 16px;
      font-weight: 700;
      display: flex;
      flex-direction: column;
      gap: 6px;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .aperto { background: #1f7a33; }
    .chiuso { background: #8b1e1e; }
    .limitato { background: #b37a00; }
    .unknown { background: #444; }

    .banner-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    main {
      display: flex;
      flex-direction: column;
    }

    body.office main {
      flex-direction: row;
      height: calc(100vh - 120px);
    }

    section {
      padding: 16px;
    }

    body.office section {
      flex: 1;
    }

    .label {
      opacity: 0.7;
      font-size: 14px;
    }

    body.office .label {
      font-size: 18px;
    }

    .value {
      font-size: 18px;
      margin-bottom: 12px;
    }

    body.office .value {
      font-size: 26px;
    }

    #map {
      width: 100%;
      height: 420px;
      border-radius: 10px;
    }

    body.office #map {
      height: 100%;
    }
  </style>

  <!-- GOOGLE MAPS -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD3H4aVAjeJQIERs5hXDCKlZZJMv64GHmo&callback=initMap"
    async
    defer
  ></script>
</head>

<body>
  <header>
    <span>Tenda Monitor</span>
    <button id="officeToggle">Modalità ufficio</button>
  </header>

  <div id="banner" class="banner unknown">
    <div class="banner-top">
      <span id="banner-text">Aggiornamento stato…</span>
      <span id="banner-time"></span>
    </div>
    <div id="banner-extra"></div>
  </div>

  <main>
    <section>
      <div class="label">Stato tunnel</div>
      <div class="value" id="stato">—</div>

      <div class="label">Traffico</div>
      <div class="value" id="traffico">—</div>

      <div class="label">Veicoli stimati</div>
      <div class="value" id="veicoli">—</div>

      <div class="label">Fonte</div>
      <div class="value" id="fonte">—</div>

      <div class="label">Ultimo aggiornamento</div>
      <div class="value" id="aggiornato">—</div>
    </section>

    <section>
      <h2>Traffico in tempo reale</h2>
      <div id="map"></div>
    </section>
  </main>

  <script>
    const ENDPOINT =
      "https://tenda-regole.massimiliano-cesar.workers.dev/";

    const REFRESH_NORMAL = 60_000;
    const REFRESH_OFFICE = 30_000;

    let refreshTimer;

    function formatTime(iso) {
      if (!iso) return "";
      return new Date(iso).toLocaleTimeString("it-IT", {
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    function formatCountdown(minutes) {
      if (minutes == null) return null;
      const h = Math.floor(minutes / 60);
      const m = minutes % 60;
      return h > 0 ? `tra ${h}h ${m}m` : `tra ${m}m`;
    }

    function aggiornaUI(data) {
      const stato = data.stato?.toUpperCase() || "UNKNOWN";

      const banner = document.getElementById("banner");
      banner.className = "banner unknown";

      if (stato === "APERTO") banner.classList.add("aperto");
      else if (stato === "CHIUSO") banner.classList.add("chiuso");
      else if (stato === "LIMITATO") banner.classList.add("limitato");

      document.getElementById("banner-text").textContent =
        stato === "APERTO"
          ? "✅ Tunnel aperto"
          : stato === "CHIUSO"
          ? "⛔ Tunnel chiuso"
          : stato === "LIMITATO"
          ? "⚠️ Circolazione limitata"
          : "❓ Stato non disponibile";

      document.getElementById("banner-time").textContent =
        formatTime(data.aggiornato);

      let extra = [];
      if (data.apertura && data.chiusura)
        extra.push(`Orari: ${data.apertura} – ${data.chiusura}`);

      if (stato === "APERTO" && data.minuti_alla_chiusura != null)
        extra.push(`Chiude ${formatCountdown(data.minuti_alla_chiusura)}`);

      if (stato === "CHIUSO" && data.apertura)
        extra.push(`Prossima apertura ${data.apertura}`);

      document.getElementById("banner-extra").textContent =
        extra.join(" • ");

      document.getElementById("stato").textContent = stato;
      document.getElementById("traffico").textContent = data.traffico || "n/d";
      document.getElementById("veicoli").textContent =
        data.stima_veicoli ?? "n/d";
      document.getElementById("fonte").textContent = data.fonte || "n/d";
      document.getElementById("aggiornato").textContent =
        data.aggiornato
          ? new Date(data.aggiornato).toLocaleString("it-IT")
          : "n/d";
    }

    async function caricaStato() {
      try {
        const res = await fetch(ENDPOINT, { cache: "no-store" });
        const data = await res.json();
        aggiornaUI(data);
      } catch (e) {
        console.error(e);
      }
    }

    function setRefresh() {
      clearInterval(refreshTimer);
      const delay = document.body.classList.contains("office")
        ? REFRESH_OFFICE
        : REFRESH_NORMAL;
      refreshTimer = setInterval(caricaStato, delay);
    }

    document
      .getElementById("officeToggle")
      .addEventListener("click", () => {
        document.body.classList.toggle("office");
        localStorage.setItem(
          "officeMode",
          document.body.classList.contains("office")
        );
        setRefresh();
      });

    if (localStorage.getItem("officeMode") === "true") {
      document.body.classList.add("office");
    }

    function initMap() {
      const tenda = { lat: 44.1541066, lng: 7.5661378 };
      const map = new google.maps.Map(document.getElementById("map"), {
        center: tenda,
        zoom: 14,
      });
      new google.maps.Marker({ position: tenda, map });
      new google.maps.TrafficLayer().setMap(map);
    }

    caricaStato();
    setRefresh();
  </script>
</body>
</html>
