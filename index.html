<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Tenda Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0b1020;
      color: #ffffff;
    }

    header {
      padding: 16px;
      font-size: 24px;
      font-weight: 700;
    }

    .banner {
      padding: 14px 16px;
      font-weight: 600;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .aperto { background: #1f7a33; }
    .chiuso { background: #8b1e1e; }
    .limitato { background: #b37a00; }
    .unknown { background: #444; }

    .banner-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .banner-sub {
      font-size: 14px;
      opacity: 0.9;
    }

    section {
      padding: 16px;
    }

    .label {
      opacity: 0.7;
      font-size: 14px;
    }

    .value {
      font-size: 18px;
      margin-bottom: 12px;
    }
  </style>
</head>

<body>
  <header>Tenda App</header>

  <div id="banner" class="banner unknown">
    <div class="banner-top">
      <span id="banner-text">Stato tunnel in aggiornamento…</span>
      <span id="banner-time"></span>
    </div>
    <div class="banner-sub" id="banner-extra">—</div>
  </div>

  <section>
    <div class="label">Stato tunnel</div>
    <div class="value" id="stato">—</div>

    <div class="label">Traffico</div>
    <div class="value" id="traffico">—</div>

    <div class="label">Fonte</div>
    <div class="value" id="fonte">—</div>

    <div class="label">Ultimo aggiornamento</div>
    <div class="value" id="aggiornato">—</div>
  </section>

  <script>
    const ENDPOINT =
      "https://tenda-regole.massimiliano-cesar.workers.dev/";

    function formatTime(iso) {
      if (!iso) return "";
      return new Date(iso).toLocaleTimeString("it-IT", {
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    function formatCountdown(minutes) {
      if (minutes == null) return null;
      const h = Math.floor(minutes / 60);
      const m = minutes % 60;
      if (h > 0) return `tra ${h}h ${m}m`;
      return `tra ${m}m`;
    }

    function aggiornaUI(data) {
      const stato = data.stato?.toUpperCase() || "UNKNOWN";

      const banner = document.getElementById("banner");
      const bannerText = document.getElementById("banner-text");
      const bannerTime = document.getElementById("banner-time");
      const bannerExtra = document.getElementById("banner-extra");

      banner.className = "banner unknown";

      if (stato === "APERTO") {
        banner.classList.add("aperto");
        bannerText.textContent = "✅ Tunnel aperto";
      } else if (stato === "CHIUSO") {
        banner.classList.add("chiuso");
        bannerText.textContent = "⛔ Tunnel chiuso";
      } else if (stato === "LIMITATO") {
        banner.classList.add("limitato");
        bannerText.textContent = "⚠️ Circolazione limitata";
      } else {
        bannerText.textContent = "❓ Stato non disponibile";
      }

      bannerTime.textContent = formatTime(data.aggiornato);

      // Riga avanzata
      let extra = [];

      if (data.apertura && data.chiusura) {
        extra.push(`Orari: ${data.apertura} – ${data.chiusura}`);
      }

      if (stato === "APERTO" && data.minuti_alla_chiusura != null) {
        extra.push(
          `Chiude ${formatCountdown(data.minuti_alla_chiusura)}`
        );
      }

      if (stato === "CHIUSO" && data.apertura) {
        extra.push(`Prossima apertura alle ${data.apertura}`);
      }

      bannerExtra.textContent =
        extra.length > 0 ? extra.join(" • ") : "—";

      document.getElementById("stato").textContent = stato;
      document.getElementById("traffico").textContent =
        data.traffico || "n/d";
      document.getElementById("fonte").textContent =
        data.fonte || "n/d";
      document.getElementById("aggiornato").textContent =
        data.aggiornato
          ? new Date(data.aggiornato).toLocaleString("it-IT")
          : "n/d";
    }

    async function caricaStato() {
      try {
        const res = await fetch(ENDPOINT, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        aggiornaUI(data);
      } catch (err) {
        const banner = document.getElementById("banner");
        banner.className = "banner unknown";
        document.getElementById("banner-text").textContent =
          "❌ Stato tunnel non disponibile";
        document.getElementById("banner-extra").textContent = "—";
        console.error(err);
      }
    }

    caricaStato();
    setInterval(caricaStato, 60_000);
  </script>
</body>
</html>
