<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tenda Monitor</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1565c0">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f4f4;
  margin: 0;
  padding: 10px;
}

h1 {
  text-align: center;
}

#banner {
  padding: 14px;
  text-align: center;
  font-size: 1.3em;
  font-weight: bold;
  border-radius: 8px;
  margin-bottom: 10px;
}

.aperto { background: #c8f7c5; }
.chiuso { background: #ffcdd2; }
.avviso { background: #ffe082; }
.critico { background: #ff8a80; }

.box {
  background: #fff;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 10px;
  font-size: 1.05em;
}

#countdown {
  font-size: 1.4em;
  font-weight: bold;
  text-align: center;
}

#storico {
  font-size: 0.95em;
}

#map {
  width: 100%;
  height: 480px;
  border-radius: 8px;
}
</style>
</head>

<body>

<h1>üöß Tunnel del Tenda</h1>

<div id="banner">‚è≥ Caricamento‚Ä¶</div>

<div class="box" id="info"></div>
<div class="box" id="countdown"></div>
<div class="box" id="storico"></div>

<div class="box">
  <div id="map"></div>
</div>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}

const API = "https://tenda-regole.massimiliano-cesar.workers.dev/";
let cambioISO = null;

function salvaStorico(voce) {
  const s = JSON.parse(localStorage.getItem("storico") || "[]");
  s.push(voce);
  if (s.length > 20) s.shift();
  localStorage.setItem("storico", JSON.stringify(s));
}

function mostraStorico() {
  const box = document.getElementById("storico");
  const s = JSON.parse(localStorage.getItem("storico") || "[]");

  if (!s.length) {
    box.innerHTML = "<b>Storico:</b> nessun dato";
    return;
  }

  box.innerHTML = "<b>Storico traffico:</b><br>" +
    s.map(e =>
      `${e.ora} ‚Äì ${e.traffico} (${e.veicoli} veicoli)`
    ).join("<br>");
}

function formatHMS(ms) {
  if (ms <= 0) return "00:00:00";
  const s = Math.floor(ms / 1000);
  const h = String(Math.floor(s / 3600)).padStart(2, "0");
  const m = String(Math.floor((s % 3600) / 60)).padStart(2, "0");
  const sec = String(s % 60).padStart(2, "0");
  return `${h}:${m}:${sec}`;
}

async function aggiorna() {
  const banner = document.getElementById("banner");
  const info = document.getElementById("info");

  const d = await (await fetch(API, { cache: "no-store" })).json();

  let classe = "aperto";

  if (d.stato !== "APERTO") {
    classe = "chiuso";
    banner.textContent = "‚ùå Tunnel chiuso";
  } else if (d.traffico === "Critico") {
    classe = "critico";
    banner.textContent = "üö® Traffico critico";
  } else if (d.minuti_alla_chiusura <= 15) {
    classe = "avviso";
    banner.textContent = "‚ö†Ô∏è Chiusura imminente";
  } else {
    banner.textContent = "‚úÖ Aperto ‚Äì " + d.direzione_attuale;
  }

  banner.className = classe;
  cambioISO = d.prossimo_cambio_iso;

  info.innerHTML = `
    <b>Direzione:</b> ${d.direzione_attuale || "-"}<br>
    <b>Traffico:</b> ${d.traffico}<br>
    <b>Coda stimata:</b> ${d.stima_veicoli} veicoli<br>
    <b>Orari:</b> ${d.apertura} ‚Äì ${d.chiusura}
  `;

  salvaStorico({
    ora: new Date().toLocaleTimeString(),
    traffico: d.traffico,
    veicoli: d.stima_veicoli
  });

  mostraStorico();
}

function aggiornaCountdown() {
  const box = document.getElementById("countdown");
  if (!cambioISO) {
    box.textContent = "";
    return;
  }
  box.textContent =
    "‚è≥ Cambio direzione tra: " +
    formatHMS(new Date(cambioISO) - new Date());
}

aggiorna();
setInterval(aggiorna, 300000);
setInterval(aggiornaCountdown, 1000);
</script>

<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD3H4aVAjeJQIERs5hXDCKlZZJMv64GHmo&callback=initMap"
  async defer>
</script>

<script>
function initMap() {
  const pos = { lat: 44.1541066, lng: 7.5661378 };
  const map = new google.maps.Map(document.getElementById("map"), {
    center: pos,
    zoom: 14
  });
  new google.maps.Marker({ position: pos, map });
  new google.maps.TrafficLayer().setMap(map);
}
</script>

</body>
</html>
