<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Tenda Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #0b1020;
      color: #fff;
    }

    body.office {
      font-size: 20px;
    }

    header {
      padding: 16px;
      font-size: 26px;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    button {
      background: #1e293b;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
    }

    .banner {
      padding: 16px;
      font-weight: 700;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .aperto { background: #1f7a33; }
    .chiuso { background: #8b1e1e; }
    .limitato { background: #b37a00; }
    .unknown { background: #444; }

    main {
      display: flex;
      flex-direction: column;
    }

    body.office main {
      flex-direction: row;
      height: calc(100vh - 120px);
    }

    section {
      padding: 16px;
      flex: 1;
    }

    .label {
      opacity: 0.7;
      font-size: 14px;
    }

    .value {
      font-size: 18px;
      margin-bottom: 12px;
    }

    body.office .value {
      font-size: 26px;
    }

    #map {
      width: 100%;
      height: 420px;
      border-radius: 10px;
    }

    body.office #map {
      height: 100%;
    }
  </style>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD3H4aVAjeJQIERs5hXDCKlZZJMv64GHmo&callback=initMap"
    async
    defer
  ></script>
</head>

<body>
  <header>
    <span>Tenda Monitor</span>
    <div>
      <button id="soundToggle">ðŸ”• Avvisi OFF</button>
      <button id="officeToggle">ModalitÃ  ufficio</button>
    </div>
  </header>

  <div id="banner" class="banner unknown">
    <div id="banner-text">Aggiornamentoâ€¦</div>
    <div id="banner-extra"></div>
  </div>

  <main>
    <section>
      <div class="label">Stato tunnel</div>
      <div class="value" id="stato">â€”</div>

      <div class="label">Traffico</div>
      <div class="value" id="traffico">â€”</div>

      <div class="label">Veicoli stimati</div>
      <div class="value" id="veicoli">â€”</div>

      <div class="label">Ultimo aggiornamento</div>
      <div class="value" id="aggiornato">â€”</div>
    </section>

    <section>
      <h2>Traffico in tempo reale</h2>
      <div id="map"></div>
    </section>
  </main>

  <script>
    const ENDPOINT =
      "https://tenda-regole.massimiliano-cesar.workers.dev/";

    let lastStato = null;
    let lastCritico = false;

    let soundEnabled = localStorage.getItem("sound") === "true";

    const soundToggle = document.getElementById("soundToggle");
    soundToggle.textContent = soundEnabled ? "ðŸ”” Avvisi ON" : "ðŸ”• Avvisi OFF";

    const beep = (freq = 600) => {
      if (!soundEnabled) return;
      const ctx = new AudioContext();
      const osc = ctx.createOscillator();
      osc.frequency.value = freq;
      osc.connect(ctx.destination);
      osc.start();
      osc.stop(ctx.currentTime + 0.25);
    };

    function aggiornaUI(data) {
      const stato = data.stato;
      const veicoli = data.stima_veicoli ?? 0;

      const banner = document.getElementById("banner");
      banner.className = "banner " + (stato || "unknown").toLowerCase();

      document.getElementById("banner-text").textContent =
        stato === "APERTO"
          ? "âœ… Tunnel aperto"
          : stato === "CHIUSO"
          ? "â›” Tunnel chiuso"
          : stato === "LIMITATO"
          ? "âš ï¸ Circolazione limitata"
          : "â“ Stato sconosciuto";

      document.getElementById("banner-extra").textContent =
        data.apertura && data.chiusura
          ? `Orari: ${data.apertura} â€“ ${data.chiusura}`
          : "";

      document.getElementById("stato").textContent = stato;
      document.getElementById("traffico").textContent = data.traffico;
      document.getElementById("veicoli").textContent = veicoli;
      document.getElementById("aggiornato").textContent =
        new Date(data.aggiornato).toLocaleString("it-IT");

      // ðŸ”” AVVISI SONORI
      if (lastStato && stato !== lastStato) {
        if (stato === "CHIUSO") beep(300);
        if (stato === "APERTO") beep(900);
      }

      const critico = veicoli > 20;
      if (critico && !lastCritico) {
        beep(1200);
        setTimeout(() => beep(1200), 400);
      }

      lastStato = stato;
      lastCritico = critico;
    }

    async function caricaStato() {
      try {
        const res = await fetch(ENDPOINT, { cache: "no-store" });
        const data = await res.json();
        aggiornaUI(data);
      } catch (e) {
        console.error(e);
      }
    }

    soundToggle.onclick = () => {
      soundEnabled = !soundEnabled;
      localStorage.setItem("sound", soundEnabled);
      soundToggle.textContent = soundEnabled
        ? "ðŸ”” Avvisi ON"
        : "ðŸ”• Avvisi OFF";
    };

    document.getElementById("officeToggle").onclick = () => {
      document.body.classList.toggle("office");
      localStorage.setItem(
        "officeMode",
        document.body.classList.contains("office")
      );
    };

    if (localStorage.getItem("officeMode") === "true") {
      document.body.classList.add("office");
    }

    function initMap() {
      const tenda = { lat: 44.1541066, lng: 7.5661378 };
      const map = new google.maps.Map(document.getElementById("map"), {
        center: tenda,
        zoom: 14,
      });
      new google.maps.Marker({ position: tenda, map });
      new google.maps.TrafficLayer().setMap(map);
    }

    caricaStato();
    setInterval(caricaStato, 30_000);
  </script>
</body>
</html>
